name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  ci_ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 2
      - name: Install apt dependencies
        run: sudo apt install -y gcc-multilib g++-multilib lcov llvm-11
      - name: Run tests
        run: python3 misc/run_tests.py tests
      - name: Verbose test info
        run: build/runner_clang_release_x64/runner -d data -v
      - name: Generate coverage
        run: LLVM_COV=llvm-cov-11 bash misc/generate_coverage.sh
      - name: Upload coverage
        run: bash <(curl -s https://codecov.io/bash) -f coverage.lcov -y .github/codecov.yml

  ci_windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: python misc/run_tests.py tests
      - name: Verbose test info
        run: build\runner_vs_cl64_release_x64\runner.exe -d data -v

  ci_picort:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run picort
        run: python misc/run_tests.py picort
      - name: Upload result images
        env:
          BUNNY_API_TOKEN: ${{ secrets.BUNNY_API_TOKEN }}
        if: always()
        continue-on-error: true
        run: |
          HASH="$(git rev-parse --short=16 HEAD)"
          URL="https://storage.bunnycdn.com/ufbx-images/$HASH"
          DST_URL="https://ufbx-images.b-cdn.net/$HASH"
          curl -sS -w "(barbarian.png) \n" --request PUT --header "AccessKey: $BUNNY_API_TOKEN" --header "Content-Type: image/png" --url $URL/barbarian.png --data-binary @build/images/barbarian.png
          echo == Result images ==
          echo $DST_URL/barbarian.png

